# 你开启的Tree-Shaking并没什么卵用

Tree-Shaking这个名词，很多前端coder已经耳熟能详了，它代表的大意就是删除没用到的代码。这样的功能对于构建大型应用时是非常好的，因为日常开发经常需要引用各种库。但大多时候仅仅使用了这些库的某些部分，并非需要全部，此时Tree-Shaking如果能帮助我们删除掉没有使用的代码，将会大大缩减打包后的代码量。

Tree-Shaking在前端界由[rollup](https://github.com/rollup/rollup)首先提出并实现，后续[webpack](https://github.com/webpack/webpack)在2.x版本也借助于[UglifyJS](https://github.com/mishoo/UglifyJS2)实现了。后续在各类讨论优化打包的文章中，都能看到Tree-Shaking的身影。

许多开发者看到就很开心，以为自己引用的elementUI、antd 等库终于可以删掉一大半了。然而理想是丰满的，现实是骨干的。升级之后，项目的压缩包并没有什么明显变化。

我也遇到了这样的问题，前段时间，需要开发个组件库。我非常纳闷我开发的组件库在打包后，为什么引用者通过ES6引用，最终依旧会把组件库中没有使用过的组件引入进来。

下面跟大家分享下，到底什么才是Tree-Shaking的正确姿势。

## Tree-Shaking的原理

这里我不多冗余阐述，直接贴 百度外卖前端的一篇文章：[Tree-Shaking性能优化实践 - 原理篇](https://juejin.im/post/5a4dc842518825698e7279a9)。

如果懒得看文章，可以看下如下总结：

1. ES6的模块引入是静态分析的，故而可以在编译时正确判断到底加载了什么代码。
2. 分析程序流，判断哪些变量未被使用、引用，进而删除此代码。

很好，原理非常完美，那为什么我们的代码又删不掉呢？

**先说原因：都是副作用的锅！**

## 副作用

了解过函数式编程的同学对副作用这词肯定不陌生。它大致可以理解成：一个函数会、或者可能会对函数外部变量产生影响的行为。

举个例子，比如这个函数：
```javascript
function go (url) {
  window.location.href = url
}
```
这个函数修改了全局变量location，甚至还让浏览器发生了跳转，这就是一个有副作用的函数。

现在我们了解了副作用了，但是细想来，我写的组件库也没有什么副作用啊，我每一个组件都是一个类，简化一下，如下所示：

```javascript
// componetns.js
export class Person {
  constructor ({ name, age, sex }) {
    this.className = 'Person'
    this.name = name
    this.age = age
    this.sex = sex
  }
  getName () {
    return this.name
  }
}
export class Apple {
  constructor ({ model }) {
    this.className = 'Apple'
    this.model = model
  }
  getModel () {
    return this.model
  }
}
```
```javascript
// main.js
import { Apple } from './components'

const appleModel = new Apple({
  model: 'IphoneX'
}).getModel()

console.log(appleModel)
```

用rollup在线repl尝试了下tree-shaking，也确实删掉了Person，[传送门](https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMEFwcGxlJTIwJTdEJTIwZnJvbSUyMCcuJTJGY29tcG9uZW50cyclNUNuJTVDbmNvbnN0JTIwYXBwbGVNb2RlbCUyMCUzRCUyMG5ldyUyMEFwcGxlKCU3QiU1Q24lMjAlMjBtb2RlbCUzQSUyMCdJcGhvbmVYJyU1Q24lN0QpLmdldE1vZGVsKCklNUNuJTVDbmNvbnNvbGUubG9nKGFwcGxlTW9kZWwpJTIyJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMmNvbXBvbmVudHMuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIyZXhwb3J0JTIwY2xhc3MlMjBQZXJzb24lMjAlN0IlNUNuJTIwJTIwY29uc3RydWN0b3IlMjAoJTdCJTIwbmFtZSUyQyUyMGFnZSUyQyUyMHNleCUyMCU3RCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5jbGFzc05hbWUlMjAlM0QlMjAnUGVyc29uJyU1Q24lMjAlMjAlMjAlMjB0aGlzLm5hbWUlMjAlM0QlMjBuYW1lJTVDbiUyMCUyMCUyMCUyMHRoaXMuYWdlJTIwJTNEJTIwYWdlJTVDbiUyMCUyMCUyMCUyMHRoaXMuc2V4JTIwJTNEJTIwc2V4JTVDbiUyMCUyMCU3RCU1Q24lMjAlMjBnZXROYW1lJTIwKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5uYW1lJTVDbiUyMCUyMCU3RCU1Q24lN0QlNUNuZXhwb3J0JTIwY2xhc3MlMjBBcHBsZSUyMCU3QiU1Q24lMjAlMjBjb25zdHJ1Y3RvciUyMCglN0IlMjBtb2RlbCUyMCU3RCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5jbGFzc05hbWUlMjAlM0QlMjAnQXBwbGUnJTVDbiUyMCUyMCUyMCUyMHRoaXMubW9kZWwlMjAlM0QlMjBtb2RlbCU1Q24lMjAlMjAlN0QlNUNuJTIwJTIwZ2V0TW9kZWwlMjAoKSUyMCU3QiU1Q24lMjAlMjAlMjAlMjByZXR1cm4lMjB0aGlzLm1vZGVsJTVDbiUyMCUyMCU3RCU1Q24lN0QlMjIlN0QlNUQlMkMlMjJvcHRpb25zJTIyJTNBJTdCJTIyZm9ybWF0JTIyJTNBJTIyZXMlMjIlMkMlMjJtb2R1bGVOYW1lJTIyJTNBJTIybXlCdW5kbGUlMjIlMkMlMjJnbG9iYWxzJTIyJTNBJTdCJTdEJTJDJTIybmFtZSUyMiUzQSUyMm15QnVuZGxlJTIyJTJDJTIyYW1kJTIyJTNBJTdCJTIyaWQlMjIlM0ElMjIlMjIlN0QlN0QlMkMlMjJleGFtcGxlJTIyJTNBbnVsbCU3RA==)

可是为什么当我通过webpack打包组件库，再被他人引入时，却没办法消除未使用代码呢？

因为我忽略了两件事情：babel编译 + webpack打包

## 成也Babel，败也Babel

Babel不用我多解释了，它能把ES6/ES7的代码转化成指定浏览器能支持的代码。正是由于它，我们前端开发者才能有今天这样美好的开发环境，能够不用考虑浏览器兼容性地、畅快淋漓地使用最新的JavaScript语言特性。

然而也是由于它的编译，一些我们原本看似没有副作用的代码，便转化为了(可能)有副作用的。

比如我如上的示例，如果我们用babel先编译一下，再贴到rollup的repl，那么结果如下：

[传送门](https://rollupjs.cn/repl?version=0.53.3&shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMEFwcGxlJTIwJTdEJTIwZnJvbSUyMCcuJTJGY29tcG9uZW50cyclNUNuJTVDbmNvbnN0JTIwYXBwbGVNb2RlbCUyMCUzRCUyMG5ldyUyMEFwcGxlKCU3QiU1Q24lMjAlMjBtb2RlbCUzQSUyMCdJcGhvbmVYJyU1Q24lN0QpLmdldE1vZGVsKCklNUNuJTVDbmNvbnNvbGUubG9nKGFwcGxlTW9kZWwpJTIyJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMmNvbXBvbmVudHMuanMlMjIlMkMlMjJjb2RlJTIyJTNBJTIydmFyJTIwX2NyZWF0ZUNsYXNzJTIwJTNEJTIwZnVuY3Rpb24lMjAoKSUyMCU3QiUyMGZ1bmN0aW9uJTIwZGVmaW5lUHJvcGVydGllcyh0YXJnZXQlMkMlMjBwcm9wcyklMjAlN0IlMjBmb3IlMjAodmFyJTIwaSUyMCUzRCUyMDAlM0IlMjBpJTIwJTNDJTIwcHJvcHMubGVuZ3RoJTNCJTIwaSUyQiUyQiklMjAlN0IlMjB2YXIlMjBkZXNjcmlwdG9yJTIwJTNEJTIwcHJvcHMlNUJpJTVEJTNCJTIwZGVzY3JpcHRvci5lbnVtZXJhYmxlJTIwJTNEJTIwZGVzY3JpcHRvci5lbnVtZXJhYmxlJTIwJTdDJTdDJTIwZmFsc2UlM0IlMjBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSUyMCUzRCUyMHRydWUlM0IlMjBpZiUyMCglNUMlMjJ2YWx1ZSU1QyUyMiUyMGluJTIwZGVzY3JpcHRvciklMjBkZXNjcmlwdG9yLndyaXRhYmxlJTIwJTNEJTIwdHJ1ZSUzQiUyME9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQlMkMlMjBkZXNjcmlwdG9yLmtleSUyQyUyMGRlc2NyaXB0b3IpJTNCJTIwJTdEJTIwJTdEJTIwcmV0dXJuJTIwZnVuY3Rpb24lMjAoQ29uc3RydWN0b3IlMkMlMjBwcm90b1Byb3BzJTJDJTIwc3RhdGljUHJvcHMpJTIwJTdCJTIwaWYlMjAocHJvdG9Qcm9wcyklMjBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSUyQyUyMHByb3RvUHJvcHMpJTNCJTIwaWYlMjAoc3RhdGljUHJvcHMpJTIwZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3RvciUyQyUyMHN0YXRpY1Byb3BzKSUzQiUyMHJldHVybiUyMENvbnN0cnVjdG9yJTNCJTIwJTdEJTNCJTIwJTdEKCklM0IlNUNuJTVDbmZ1bmN0aW9uJTIwX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlJTJDJTIwQ29uc3RydWN0b3IpJTIwJTdCJTIwaWYlMjAoIShpbnN0YW5jZSUyMGluc3RhbmNlb2YlMjBDb25zdHJ1Y3RvcikpJTIwJTdCJTIwdGhyb3clMjBuZXclMjBUeXBlRXJyb3IoJTVDJTIyQ2Fubm90JTIwY2FsbCUyMGElMjBjbGFzcyUyMGFzJTIwYSUyMGZ1bmN0aW9uJTVDJTIyKSUzQiUyMCU3RCUyMCU3RCU1Q24lNUNudmFyJTIwUGVyc29uJTIwJTNEJTIwZnVuY3Rpb24lMjAoKSUyMCU3QiU1Q24lMjAlMjBmdW5jdGlvbiUyMFBlcnNvbihfcmVmKSUyMCU3QiU1Q24lMjAlMjAlMjAlMjB2YXIlMjBuYW1lJTIwJTNEJTIwX3JlZi5uYW1lJTJDJTVDbiUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGFnZSUyMCUzRCUyMF9yZWYuYWdlJTJDJTVDbiUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNleCUyMCUzRCUyMF9yZWYuc2V4JTNCJTVDbiU1Q24lMjAlMjAlMjAlMjBfY2xhc3NDYWxsQ2hlY2sodGhpcyUyQyUyMFBlcnNvbiklM0IlNUNuJTVDbiUyMCUyMCUyMCUyMHRoaXMuY2xhc3NOYW1lJTIwJTNEJTIwJ1BlcnNvbiclM0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5uYW1lJTIwJTNEJTIwbmFtZSUzQiU1Q24lMjAlMjAlMjAlMjB0aGlzLmFnZSUyMCUzRCUyMGFnZSUzQiU1Q24lMjAlMjAlMjAlMjB0aGlzLnNleCUyMCUzRCUyMHNleCUzQiU1Q24lMjAlMjAlN0QlNUNuJTVDbiUyMCUyMF9jcmVhdGVDbGFzcyhQZXJzb24lMkMlMjAlNUIlN0IlNUNuJTIwJTIwJTIwJTIwa2V5JTNBJTIwJ2dldE5hbWUnJTJDJTVDbiUyMCUyMCUyMCUyMHZhbHVlJTNBJTIwZnVuY3Rpb24lMjBnZXROYW1lKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5uYW1lJTNCJTVDbiUyMCUyMCUyMCUyMCU3RCU1Q24lMjAlMjAlN0QlNUQpJTNCJTVDbiU1Q24lMjAlMjByZXR1cm4lMjBQZXJzb24lM0IlNUNuJTdEKCklM0IlNUNudmFyJTIwQXBwbGUlMjAlM0QlMjBmdW5jdGlvbiUyMCgpJTIwJTdCJTVDbiUyMCUyMGZ1bmN0aW9uJTIwQXBwbGUoX3JlZjIpJTIwJTdCJTVDbiUyMCUyMCUyMCUyMHZhciUyMG1vZGVsJTIwJTNEJTIwX3JlZjIubW9kZWwlM0IlNUNuJTVDbiUyMCUyMCUyMCUyMF9jbGFzc0NhbGxDaGVjayh0aGlzJTJDJTIwQXBwbGUpJTNCJTVDbiU1Q24lMjAlMjAlMjAlMjB0aGlzLmNsYXNzTmFtZSUyMCUzRCUyMCdBcHBsZSclM0IlNUNuJTIwJTIwJTIwJTIwdGhpcy5tb2RlbCUyMCUzRCUyMG1vZGVsJTNCJTVDbiUyMCUyMCU3RCU1Q24lNUNuJTIwJTIwX2NyZWF0ZUNsYXNzKEFwcGxlJTJDJTIwJTVCJTdCJTVDbiUyMCUyMCUyMCUyMGtleSUzQSUyMCdnZXRNb2RlbCclMkMlNUNuJTIwJTIwJTIwJTIwdmFsdWUlM0ElMjBmdW5jdGlvbiUyMGdldE1vZGVsKCklMjAlN0IlNUNuJTIwJTIwJTIwJTIwJTIwJTIwcmV0dXJuJTIwdGhpcy5tb2RlbCUzQiU1Q24lMjAlMjAlMjAlMjAlN0QlNUNuJTIwJTIwJTdEJTVEKSUzQiU1Q24lNUNuJTIwJTIwcmV0dXJuJTIwQXBwbGUlM0IlNUNuJTdEKCklM0IlNUNuJTVDbmV4cG9ydCUyMCU3QiUyMFBlcnNvbiUyQyUyMEFwcGxlJTIwJTdEJTNCJTVDbiUyMiU3RCU1RCUyQyUyMm9wdGlvbnMlMjIlM0ElN0IlMjJmb3JtYXQlMjIlM0ElMjJlcyUyMiUyQyUyMm1vZHVsZU5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmdsb2JhbHMlMjIlM0ElN0IlN0QlMkMlMjJuYW1lJTIyJTNBJTIybXlCdW5kbGUlMjIlMkMlMjJhbWQlMjIlM0ElN0IlMjJpZCUyMiUzQSUyMiUyMiU3RCU3RCUyQyUyMmV4YW1wbGUlMjIlM0FudWxsJTdE)


class 的副作用：https://github.com/mishoo/UglifyJS2/issues/1261

副作用例子：https://github.com/rollup/rollup/tree/master/test/form/samples
